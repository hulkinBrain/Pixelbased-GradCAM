<!DOCTYPE html>

<html lang="en">
    <head>
        <title>Hello!</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="web/css/index.css">
        <link rel="stylesheet" href="web/css/animate.min.css">
        <link rel="stylesheet" href="web/css/bulma.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="web/css/nouislider.min.css">
        <script src="web/js/nouislider.min.js"></script>

<!--        <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>-->
        <script src="web/js/lists.js"></script>
        <script src="web/js/papaparse.js"></script>

    </head>
    <body>
    <nav class="navbar" role="navigation" aria-label="main navigation" style="display: flex; align-items: center">
        <div class="navbar-brand">
            <a class="navbar-item">
                <h2 class="title">Tool</h2>
            </a>
        </div>
        <div class="navbar-menu" style="display: flex;">
            <div class="navbar-start">
                <a href="#patchesNav" class="navbar-item">Patches</a>
                <a href="#interestingCasesNav" class="navbar-item">Interesting Cases</a>
            </div>
            <div class="navbar-end">
                <div class="select heatmapSelect" style="display: none">
                    <select>
                    </select>
                </div>
                <button class="button is-primary" onclick="toggleControlsModal()">Controls [C]</button>
                <button class="button is-link is-light" onclick='toggleInterestingPoints()'>Toggle interesting points[Q]</button>
                <button class="button is-success is-light" onclick='download(JSON.stringify(interestingJsonData));'>Save Interesting Patches[S]</button>
            </div>
        </div>
    </nav>
        <div class="masterContainer">
            <div class="modal controlsModal">
                <div class="modal-background"
                     onclick='document.querySelector(".controlsModal").classList.remove("is-active")'></div>
                <div class="modal-content" style="min-width: 600px; width: 50vw;">
                    <section class="section box modalContentBox" style="min-width: 600px; width: 50vw;">
                        <div class="container">
                            <h1 class="title">Controls</h1>
                            <section class="contentBody">
                                <div class="tableContainer">
                                    <table class="controlsTable table is-striped is-fullwidth">
                                        <thead>
                                        <tr>
                                            <th>Keys</th>
                                            <th>Description</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td><span class="codeBlock">Left Click</span></td>
                                            <td>Create patch</td>
                                        </tr>
                                        <tr>
                                            <td><span class="codeBlock">Double click</span></td>
                                            <td>Adds/Removes the patch from the "Patch Comparison" container</td>
                                        </tr>
                                        <tr>
                                            <td><span class="codeBlock">Ctrl+LeftClick</span></td>
                                            <td>Toggles the patch as an “Interesting Patch”</td>
                                        </tr>
                                        <tr>
                                            <td><span class="codeBlock">Ctrl+Alt+LeftClick</span></td>
                                            <td>Removes interesting points (if exist)/patch</td>
                                        </tr>
                                        <tr>
                                            <td><span class="codeBlock">Shift+ScrollUp/Down</span></td>
                                            <td>Changes opacity of Patch / Input image</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                        </div>
                    </section>
                </div>
                <button class="modal-close is-large"
                        onclick='document.querySelector(".controlsModal").classList.remove("is-active")'
                        aria-label="close"></button>
            </div>
            <div class="block1">
                <div class="fileSelectorMasterContainer">
                    <section class="fileSelectorContainer fileSelectorContainer1">
                        <div class="wrapper">
                            <canvas id="canvas2" width="200" height="200">
                            </canvas>
                            <canvas class="editable" id="canvas1" width="200" height="200">
                            </canvas>
                            <div class="interestingPointsContainer">
                                <svg class="templatePoint" style="display: none">
                                    <circle r="7" cx="11.5" cy="11.5" stroke="black" stroke-width="2"
                                            fill="rgba(139, 195, 74, 1)">
                                        <animate attributeName="r" values="7;10;7" dur="3s" repeatCount="indefinite"></animate>
                                    </circle>
                                </svg>
                            </div>
                        </div>
                        <div class="imgName"></div>
                        <div class="fileInputContainer">
                            <div class="file">
                                <label class="ogImageInputLabel file-label">
                                    <input accept=".jpg, .png" id="ogImageInput" class="file-input" type="file" name="ogImage">
                                    <span class="file-cta">
                                    <span class="material-icons">
                                        publish
                                    </span>
                                    <span class="file-label">
                                        Choose image
                                    </span>
                                </span>
                                </label>
                            </div>
                            <div class="file secondaryFile">
                                <label class="semsegImageInputLabel file-label">
                                    <input accept=".jpg, .png" id="semsegImageInput" class="file-input" type="file" name="semSegImage">
                                    <span class="file-cta">
                                    <span class="material-icons">
                                        publish
                                    </span>
                                    <span class="file-label">
                                        Choose SemSeg image
                                    </span>
                                </span>
                                </label>
                            </div>
                            <div class="file secondaryFile">
                                <label class="csvInputLabel file-label">
                                    <input accept=".csv" id="csvInput" class="file-input" type="file" name="csvFile">
                                    <span class="file-cta">
                                    <span class="material-icons">
                                        publish
                                    </span>
                                    <span class="file-label">
                                        Choose CSV File
                                    </span>
                                </span>
                                </label>
                            </div>
                        </div>
                        <div id="behaviourSlider"></div>
                    </section>
                </div>
                <section class="patchBodyContainer">
                    <section class="hero">
                        <div class="hero-body">
                            <div id="patchesNav" class="ontainer">
                                <h1 class="title" style="margin: 0 10px;">
                                    Patches
                                </h1>
                                <section class="patchesContainer">

                                </section>
                            </div>
                        </div>
                    </section>
                    <section class="hero">
                        <div class="hero-body">
                            <div id="interestingCasesNav" class="container">
                                <h1 class="title" style="margin: 0 10px;">
                                    Interesting Cases
                                </h1>
                                <div class="select heatmapSelect" style="display: none">
                                    <select></select>
                                </div>
                                <section class="interestingPatchesContainer"></section>
                            </div>
                        </div>
                    </section>
                </section>
            </div>
            <div class="block2">
                <section class="hero">
                    <div class="patchCompareHeader">
                        <h1 class="title">
                            Compare Patches:
                        </h1>
                        <div class="expand" onclick="toggleCompareContainer()">
                            <span class="material-icons">
                                arrow_forward
                            </span>
                        </div>
                        <div class="closePatchCompareContainerButton" onclick="closePatchCompareContainer()" style="cursor: pointer">
                            <span class="material-icons">
                                close
                            </span>
                        </div>
                    </div>
                    <section class="patchCompareContainer"></section>
                </section>
            </div>
            <div class="floatingTab floatingTab1">
                <div class="classId">
                    <span class="infoLabel">Class ID: </span>
                    <span class="infoContent"></span>
                </div>
                <div class="className">
                    <span class="infoLabel">Class Name: </span>
                    <span class="infoContent"></span>
                </div>
                <div class="rgb" style="display: flex; align-items: center">
                    <div class="infoLabel">RGB: </div>
                    <div class="colorBlock" style="margin-left: 5px; width: 15px; height: 15px; background-color: black;"></div>
                    <div class="infoContent" style="margin-left: 5px;"></div>
                </div>
                <div class="position">
                    <span class="infoLabel">Position: </span>
                    <span class="infoContent"></span>
                </div>
                <svg class="divEar" height="20" width="20">
                    <polygon points="0,0 10,10 20,0"></polygon>
                </svg>
            </div>
            <div class="floatingTab floatingTab2">
                <div class="classId">
                    <span class="infoLabel">Class ID: </span>
                    <span class="infoContent"></span>
                </div>
                <div class="className">
                    <span class="infoLabel">Class Name: </span>
                    <span class="infoContent"></span>
                </div>
                <div class="rgb" style="display: flex; align-items: center">
                    <div class="infoLabel">RGB: </div>
                    <div class="colorBlock" style="margin-left: 5px; width: 15px; height: 15px; background-color: black;"></div>
                    <div class="infoContent" style="margin-left: 5px;"></div>
                </div>
                <div class="position">
                    <span class="infoLabel">Position: </span>
                    <span class="infoContent"></span>
                </div>
                <svg class="divEar" height="20" width="20">
                    <polygon points="0,0 10,10 20,0"></polygon>
                </svg>
            </div>
            <div class="toast">
                Loaded!
            </div>
            <div class="patchWindow"></div>
            <div class="sliderContainer">
            </div>
            <div class="progressbarContainer">
                <h1 class="title has-text-white">Loading...</h1>
<!--                <progress class="progress is-success" max="100"></progress>-->
            </div>

        </div>
        <script>
            function toggleControlsModal() {
				let controlsModal = document.querySelector(".controlsModal");
				controlsModal.classList.add("is-active");
			}
        </script>
        <script>
            let interstingJsonFileLoaded = false;
            let root = "web/";
            //Fetch classlist json
            let classlist = Object.values(classlistJson);
            pixelListUrl = `${root}data/2007_000033/2007_000033.csv`;
            let imageName = "2007_000033";
            let csvLocalInput = document.querySelector("#csvInput");
            // let ogImageLabel = document.querySelector(".ogImageInputLabel");
            let semSegImageLabel = document.querySelector(".semsegImageInputLabel");
            let csvInputLabel = document.querySelector(".csvInputLabel");
            let ogImageInput = document.querySelector("#ogImageInput");
            let semsegImageInput = document.querySelector("#semsegImageInput");
            let pixelList = [];
            let overlay = document.querySelector(".progressbarContainer");

            // To load positions of interesting patches in user stored images from a JSON file
            let interestingJsonData = {};
            let interestingPositions;

            ogImageInput.onchange = (e) => {
                interestingPositions = new Set();
                document.querySelectorAll(".interestingPointSvg").forEach(el => el.remove());
                // Change canvas images When user uploads some image
                if(e.injectedImage != undefined || e.injectedImage != null)
                    renderCanvasImage(e.injectedImage, canvas1);   // Used when using Interesting cases items are clicked
                else{
                    imageName = ogImageInput.files[0].name.split(".").slice(0, -1).join(".");
                    renderCanvasImage(ogImageInput.files[0], canvas1);
                    patchWindow.style.borderColor = "black";
                    //Trigger Semantic segmentation file picker
                    semSegImageLabel.click();
                    //Trigger csv file picker
                    csvInputLabel.click();
                }
            };
            // Load image GradCAM pixel data from csv file
            function loadFile(fileOrUri) {
                // overlay.style.display = "flex";
                console.time("loadCSV");
                let progressBarContainer = document.querySelector(".progressbarContainer");
                progressBarContainer.style.display = "flex";
                pixelList = [];
                let iter = 0;
                Papa.parse(fileOrUri, {
                    delimiter: " ",
                    newline: "\n\n",
                    download: true,
                    fastMode: true,
                    // step: (row) => {
                    //     if(iter === 0) {
                    //         console.log(0.31%1 !== 0);
                    //         pixelList.push(row.data);
                    //         iter++;
                    //     }
                    //     else {
                    //         if((parseFloat(pixelList[pixelList.length - 1][0])%1 !== 0) == (parseFloat(row.data[0])%1 !== 0))
                    //             pixelList[pixelList.length-1] = [pixelList[pixelList.length-1].concat(row.data)];
                    //         else
                    //             pixelList.push(row.data);
                    //     }
                    // },
                    complete: (result) => {
                        pixelList = result.data;
                        progressBarContainer.style.display = "none";
                        document.querySelector(".patchesContainer").innerHTML = "";
                        toast("Loaded!");
                        console.timeEnd("loadCSV");
                    },
                });
            }

            //Selectors
            let default_ogImageSrc = `${root}media/2007_000033.jpg`;
            let default_semsegImageSrc = `${root}media/2007_000033.png`;

            // Canvas elements
            let canvas1 = document.querySelector("#canvas1");
            let canvas2 = document.querySelector("#canvas2");
            let ctx1 = canvas1.getContext("2d"),
                ctx2 = canvas2.getContext("2d");
            let ogCanvasWidth, ogCanvasHeight;
            let imgData;

            // default rendering of canvas images
            // loadFile(pixelListUrl);
            // renderCanvasImage(default_ogImageSrc, canvas1);
            // renderCanvasImage(default_semsegImageSrc, canvas2);

            // Change canvas images When user uploads some image
            semsegImageInput.onchange = (e) => {
                if(e.injectedImage != undefined || e.injectedImage != null)
                    renderCanvasImage(e.injectedImage, canvas2);   // Used when using Interesting cases items are clicked
                else
                    renderCanvasImage(semsegImageInput.files[0], canvas2);
            };
            csvInputLabel.onchange = () => {
                loadFile(csvLocalInput.files[0]);
            };

            let floatingTab1 = document.querySelector(".floatingTab1");
            let floatingTab2 = document.querySelector(".floatingTab2");
            let bbox;   // Bounding box of patch window in canvas1

            let patchWindow = document.querySelector(".patchWindow");
            // Convert 1D index to 2D index
            let pos1D22D = (el) => [Math.floor(el/ogCanvasWidth), Math.floor(el%ogCanvasWidth)];
            // Convert 2D index to 1D index
            let pos2D21D = (el, width) => el[0]*width+el[1];
            let bboxArr = (arr) => [[Math.min.apply(Math, arr.map((el) => el[0])), Math.max.apply(Math, arr.map((el) => el[0]))], [Math.min.apply(Math, arr.map((el) => el[1])), Math.max.apply(Math, arr.map((el) => el[1]))]];
            let pixelPosition = [];

            // Handle mouse movements in both Canvas images
            canvas1.onmousemove = (e) => {
                let pos1D = e.layerX + ogCanvasWidth * e.layerY;
                let id1 = pos1D*2;
                let id2 = pos1D*2+1;
                let row = pixelList[id1].map(Number).map(el => pos1D22D(el));
                bbox = bboxArr(row);
                patchWindow.style.display = "block";
                patchWindow.style.width = `${bbox[1][1]-bbox[1][0]}px`;
                patchWindow.style.height = `${bbox[0][1]-bbox[0][0]}px`;
                pixelPosition = [e.layerX, e.layerY];
                let offsets = [e.clientX - (e.layerX-bbox[1][0]), e.clientY - (e.layerY-bbox[0][0])];
                patchWindow.style.left = `${offsets[0]}px`;
                patchWindow.style.top = `${offsets[1]}px`;
                // renderFloatingTab(e, floatingTab1, ctx1);
                renderFloatingTab(e, floatingTab2, ctx2, offsets);
            };
            canvas1.onclick = (e) => {
                pixelPosition = [e.layerX, e.layerY];
                let pos1D = pos2D21D([e.layerY, e.layerX], ogCanvasWidth);
                let pixelClass = ctx2.getImageData(e.layerX, e.layerY, 1, 1);
                let semSegPixelColor = pixelClass.data.slice(0, 3);
                let semSegPixelData = findClass([semSegPixelColor[0], semSegPixelColor[1], semSegPixelColor[2]]);
                let row = pixelList[pos1D*2].map(Number);
                let weights = pixelList[pos1D*2 + 1].map(Number);
                let weightRange=[0.5, 1];
                row = row.map(el => {
                    let k = pos1D22D(el);
                    k[0]-=bbox[0][0];
                    k[1]-=bbox[1][0];
                    return pos2D21D(k, bbox[0][1]-bbox[0][0])
                });
                let gradCamColors = weights.map(el => getGradCamColor(el));
                let patchWidth = bbox[1][1]-bbox[1][0];
                let patchHeight = bbox[0][1]-bbox[0][0];

                let patchesContainer = document.querySelector(".patchesContainer");
                let patchClassContainer;

                // Create Patch Class container containing patches of same classes
                if(patchesContainer.querySelector(`.${semSegPixelData[0].className}`) == null) {
                    patchClassContainer = document.createElement("div");
                    patchClassContainer.setAttribute("class", `${semSegPixelData[0].className} patchClassContainer`);
                    patchClassContainer.setAttribute("classID", semSegPixelData[0].id);
                    patchClassContainer.style.marginTop = "10px";
                    // Bulma styling
                    let h5 = document.createElement("h5");
                    h5.setAttribute("class", "title is-5 patchClassTitle");

                    // bulma styling end
                    h5.style.margin = "0 0 10px 10px";
                    let titleText = `${semSegPixelData[0].className}`;
                    titleText = titleText.charAt(0).toUpperCase() + titleText.slice(1);
                    h5.innerHTML = titleText;
                    patchClassContainer.appendChild(h5);
                    let body = document.createElement("div");
                    body.setAttribute("class", "body");
                    patchClassContainer.appendChild(body);
                    patchesContainer.appendChild(patchClassContainer);
                }
                // Select Patch Class container containing patches of same classes
                else {
                    patchClassContainer = document.querySelector(`.${semSegPixelData[0].className}`);
                }
                // Create container to contain patch and mask
                let patchContainer = document.createElement("div");
                patchContainer.setAttribute("class", "patchContainer");
                patchContainer.setAttribute("classID", semSegPixelData[0].id);
                patchContainer.setAttribute("pos1D", pos1D);
                patchContainer.setAttribute("imageName", imageName);
                let scale = 160/patchWidth;

                let wrapper = document.createElement("div");
                wrapper.setAttribute("class", "wrapper");
                wrapper.style.width = `${patchWidth*scale + 20}px`;
                wrapper.style.height = `${patchHeight*scale}px`;

                // Create canvas element to hold the patch
                let patchCanvas = document.createElement("canvas");
                patchCanvas.setAttribute("class", "patch");
                patchCanvas.style.position = "absolute";
                patchCanvas.setAttribute("pixelx", pixelPosition[0]);
                patchCanvas.setAttribute("pixely", pixelPosition[1]);
                patchCanvas.setAttribute("offsetLeft", (e.layerX-bbox[1][0]));
                patchCanvas.setAttribute("offsetTop", (e.layerY-bbox[0][0]));
                patchCanvas.setAttribute("bbox_w", bbox[1][1]-bbox[1][0]);
                patchCanvas.setAttribute("bbox_h", bbox[0][1]-bbox[0][0]);
                patchCanvas.width = patchWidth*scale;
                patchCanvas.height = patchHeight*scale;
                let imageData = ctx1.getImageData(bbox[1][0], bbox[0][0], patchWidth, patchHeight);
                let patchCtx = patchCanvas.getContext("2d");
                patchCtx.putImageData(imageData, 0, 0);
                patchCtx.imageSmoothingEnabled = false;
                patchCtx.drawImage(patchCanvas, 0, 0, patchWidth, patchHeight, 0, 0, patchWidth*scale, patchHeight*scale);

                // Create canvas element to hold the mask
                let maskCanvas = document.createElement("canvas");
                maskCanvas.setAttribute("class", "mask");
                maskCanvas.style.position = "absolute";
                maskCanvas.style.opacity = 1;
                maskCanvas.width = patchWidth*scale;
                maskCanvas.height = patchHeight*scale;
                let maskCtx = maskCanvas.getContext("2d");
                let maskImageData = maskCtx.createImageData(imageData);
                updateMask(row, weights, gradCamColors, weightRange, maskImageData);
                maskCtx.putImageData(maskImageData, 0, 0);
                maskCtx.imageSmoothingEnabled = false;
                maskCtx.globalCompositeOperation = 'copy';
                maskCtx.drawImage(maskCanvas, 0, 0, patchWidth, patchHeight, 0, 0, patchWidth*scale, patchHeight*scale);
                maskCtx.globalCompositeOperation = 'source-over';

                //Create line which goes from topleft of patch to pixel location in Original image
                let hrLine = document.createElement("hr");
                hrLine.style.display = "none";

                // Add colorscale range for mask (gradCam) canvas
                let [gradCamScaleContainer, gradientScale] = createScale([10, patchCanvas.height-15]);
                gradCamScaleContainer.style.position = "absolute";
                gradCamScaleContainer.style.transform = `translateX(${patchCanvas.width+15}px)`;
                let gradCamSlider = gradCamScaleContainer.lastChild;
                gradCamSlider.querySelector(".noUi-base").style.backgroundImage = gradientScale;
                gradCamSlider.noUiSlider.on('update', () => {
                    let sliderValues = gradCamSlider.noUiSlider.get();
                    weightRange = sliderValues.map(Number);
                    updateMask(row, weights, gradCamColors, weightRange, maskImageData);
                    maskCtx.putImageData(maskImageData, 0, 0);
                    maskCtx.imageSmoothingEnabled = false;
                    maskCtx.globalCompositeOperation = 'copy';
                    maskCtx.drawImage(maskCanvas, 0, 0, patchWidth, patchHeight, 0, 0, patchWidth*scale, patchHeight*scale);
                    maskCtx.globalCompositeOperation = 'source-over';
                });

                // Add Patch, Mask and pointing line to the patchContainer for rendering
                wrapper.appendChild(patchCanvas);
                wrapper.appendChild(maskCanvas);
                patchContainer.appendChild(wrapper);
                patchContainer.appendChild(hrLine);
                patchContainer.appendChild(gradCamScaleContainer);
                patchClassContainer.querySelector(".body").appendChild(patchContainer);

                // Additional Styling when patch is created after clicking an interestingPoint
                if(e.isInteresting === true) {
                    patchContainer.setAttribute("interesting", "1");
                    patchCanvas.style.border = "5px solid #8bc34a";
                    patchCanvas.style.borderRadius = "5px";
                    maskCanvas.style.marginTop = "5px";
                    maskCanvas.style.marginLeft = "5px";
                    hrLine.style.borderColor = "#8bc34a";
                }

                patchContainer.onmousemove = (e) => {
                    let canvas1Rect = canvas1.getBoundingClientRect();
                    let patchRect = patchContainer.getBoundingClientRect();
                    let pixelPos = [parseInt(patchCanvas.getAttribute("pixelx")), parseInt(patchCanvas.getAttribute("pixely"))];
                    let offsets = [parseInt(patchCanvas.getAttribute("offsetLeft")), parseInt(patchCanvas.getAttribute("offsetTop"))];
                    if(patchContainer.getAttribute("interesting") === "1") {
                        patchWindow.style.borderColor = "#8bc34a";
                    }
                    else
                        patchWindow.style.borderColor = "black";
                    patchWindow.style.display = "block";
                    patchWindow.style.width = `${patchCanvas.getAttribute("bbox_w")}px`;
                    patchWindow.style.height = `${patchCanvas.getAttribute("bbox_h")}px`;
                    patchWindow.style.left = `${Math.abs(canvas1Rect.left + pixelPos[0])-offsets[0]}px`;
                    patchWindow.style.top = `${Math.abs(canvas1Rect.top + pixelPos[1])-offsets[1]}px`;

                    hrLine.style.display = "block";
                    let a = patchRect.left - (Math.abs(canvas1Rect.left + pixelPos[0]));
                    let b = patchRect.top - (Math.abs(canvas1Rect.top + pixelPos[1]));
                    let theta = Math.atan2(b, a) * 180/Math.PI;
                    hrLine.style.width = `${Math.sqrt(a*a + b*b)}px`;
                    hrLine.style.transform = `translate(0, -${hrLine.offsetTop-patchRect.top}px) rotate(${180+theta}deg)`;
                    gradCamScaleContainer.style.visibility = "visible";
                };
                patchContainer.onmouseleave = () => {
                    hrLine.style.display = "none";
                    patchWindow.style.display = "none";
                    gradCamScaleContainer.style.visibility = "hidden";
                    patchWindow.style.borderColor = "black";
                };
                patchContainer.onclick = (e) => {
                    if(e.ctrlKey && e.altKey){
                        if(patchContainer === patchContainer.parentNode.lastChild && patchContainer.parentNode.childElementCount === 1) {
                            // Remove the patchClassContainer if the patch to be removed is the last one
                            patchClassContainer.remove();
                        }
                        else
                            patchContainer.remove();
                    }
                    else if(e.ctrlKey){
                        if(patchContainer.getAttribute("interesting") === null) {
                            patchContainer.setAttribute("interesting", "1");
                            patchCanvas.style.border = "5px solid #8bc34a";
                            maskCanvas.style.marginTop = "5px";
                            maskCanvas.style.marginLeft = "5px";
                            patchCanvas.style.borderRadius = "3px";
                            hrLine.style.borderTop = "2px solid #8bc34a";
                            patchWindow.style.borderColor = "#8bc34a";
                            interestingPositions.add(pos1D);
                            interestingJsonData[imageName] = [...interestingPositions];
                            renderInterestingPoint(pos1D);
                        }
                        else{
                            patchContainer.removeAttribute("interesting");
                            patchCanvas.style.border = "none";
                            maskCanvas.style.marginTop = "0";
                            maskCanvas.style.marginLeft = "0";
                            patchCanvas.style.borderRadius = "0";
                            hrLine.style.borderTop = "2px solid black";
                            patchWindow.style.borderColor = "black";
                            interestingPositions.delete(pos1D);
                            if(interestingPositions.size === 0)
                                delete interestingJsonData[imageName];
                            else
                                interestingJsonData[imageName] = [...interestingPositions];
                            deleteInterestingPoint(pos1D);
                        }

                    }
                };
                patchContainer.ondblclick = () => {
                    let patchCompareContainer = document.querySelector(".patchCompareContainer");
                    if(patchCompareContainer.childNodes.length >= 0) {
                        let block2 = document.querySelector(".block2");
                        block2.style.display = "block";
                        if(parseInt(block2.style.right) < 0)
                            toggleCompareContainer();
                    }
                    if(patchContainer.getAttribute("compare") === null) {
                        // To put patch into compare div
                        patchCompareContainer.append(patchContainer);
                        patchContainer.setAttribute("compare", 1);
                    }
                    else {
                        // To put the patch back into it's original container
                        let classID = patchContainer.getAttribute("classID");
                        document.querySelectorAll(`.patchClassContainer[classID="${classID}"] > .body`)[0].appendChild(patchContainer);
                        patchContainer.removeAttribute("compare");
                        if(patchCompareContainer.childNodes.length === 0) {
                            toggleCompareContainer();
                            document.querySelector(".block2").style.display = "none";
                        }
                    }
                };
                patchContainer.onwheel = (e) => {
                    if(e.shiftKey){
                        if(e.deltaY > 0) {
                            let prevOpacity = maskCanvas.style.opacity;
                            if(prevOpacity > 0 && prevOpacity <= 1) {
                                maskCanvas.style.opacity -= 0.1;
                            }
                        }
                        else if(e.deltaY < 0) {
                            let prevOpacity = maskCanvas.style.opacity;
                            if(prevOpacity >= 0 && prevOpacity < 1) {
                                maskCanvas.style.opacity -= -0.1;
                            }
                        }
                    }
                }
            };
            canvas1.onwheel = (e) => {
                if(canvas1.style.opacity === "")
                    canvas1.style.opacity = 1.0;
                if(e.shiftKey){
                    if(e.deltaY > 0) {
                        let prevOpacity = canvas1.style.opacity;
                        if(prevOpacity > 0 && prevOpacity <= 1) {
                            canvas1.style.opacity -= 0.1;
                        }
                    }
                    else if(e.deltaY < 0) {
                        let prevOpacity = canvas1.style.opacity;
                        if(prevOpacity >= 0 && prevOpacity < 1) {
                            canvas1.style.opacity -= -0.1;
                        }
                    }
                }
            };
            canvas1.onmouseleave = () => {
                canvas1.blur();
                patchWindow.style.display = "none";
                floatingTab2.style.display = "none";
            };

            canvas2.onmousemove = (e) => {
                renderFloatingTab(e, floatingTab2, ctx2);
            };
            canvas2.onmouseleave = () => {
                floatingTab2.style.display = "none";
            };

            // Render user input image on canvas
            function renderCanvasImage(file, canvas) {
                let wrapperDiv = document.querySelector(".fileSelectorContainer1 > .wrapper");

                let img = new Image();
                let newCanvasWidth, newCanvasHeight, aspectRatio;
                let windowWidth, windowHeight;
                windowWidth = window.innerWidth;
                windowHeight = window.innerHeight;
                img.onload = () => {
                    let fileSelectorMasterContainer = document.querySelector(".fileSelectorMasterContainer");
                    fileSelectorMasterContainer.style.top = `${(window.innerHeight - img.height)/2}px`;
                    ogCanvasWidth = img.width;
                    ogCanvasHeight = img.height;
                    newCanvasWidth = img.width;
                    newCanvasHeight = img.height;

                    // To rescale canvas image
                    // if(img.width > window.innerWidth * 0.45) {
                    //     newCanvasWidth = windowWidth * 0.45;
                    //     aspectRatio = newCanvasWidth / img.width;
                    //     newCanvasHeight = img.height * aspectRatio;
                    // }
                    // if(img.height > window.innerHeight * 0.80) {
                    //     newCanvasHeight = windowHeight * 0.80;
                    //     aspectRatio = newCanvasHeight / img.height;
                    //     newCanvasWidth = img.width * aspectRatio;
                    // }
                    canvas.width = newCanvasWidth;
                    canvas.height = newCanvasHeight;
                    wrapperDiv.style.width = `${newCanvasWidth}px`;
                    wrapperDiv.style.height = `${newCanvasHeight}px`;
                    let imgNameEl = document.querySelector(".imgName");
                    imgNameEl.innerHTML = imageName;
                    imgNameEl.style.width = `${newCanvasWidth}px`;
                    ctx = canvas.getContext("2d");
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(img, 0, 0, newCanvasWidth, newCanvasHeight);
                    if(canvas.id === "canvas1"){
                        imgData = ctx1.getImageData(0, 0, ogCanvasWidth, ogCanvasHeight);
                        loadInterestingPoints(interstingJsonFileLoaded);
                        // document.querySelector(".interestingPointsContainer").style.top = `${fileSelectorMasterContainer.style.top}px`;
                    }

                };
                if(typeof file != "string") {
                    img.src = URL.createObjectURL(file);
                }
                else {
                    img.src = file;
                }
            }

            // To render floating tab window
            function renderFloatingTab(e, tab, ctx, offsets=[0, 0]) {
                tab.style.display = "block";
                let pixel = ctx.getImageData(e.layerX, e.layerY, 1, 1);
                let pixelColor = [pixel.data[0], pixel.data[1], pixel.data[2]];
                if(tab.classList.contains("floatingTab2")) {
                    let classAttr = findClass(pixelColor)[0];
                    tab.querySelector(".classId > .infoContent").innerHTML = classAttr.id;
                    tab.querySelector(".className > .infoContent").innerHTML = classAttr.className;
                }

                tab.querySelector(".rgb > .colorBlock").style.backgroundColor = `rgb(${pixelColor[0]}, ${pixelColor[1]}, ${pixelColor[2]})`;
                tab.querySelector(".rgb > .infoContent").innerHTML = pixelColor[0] + " " +pixelColor[1] + " " + pixelColor[2];
                tab.querySelector(".position > .infoContent").innerHTML =
                    "<i>x:</i> " + e.layerX + " " +
                    "<i>y:</i> " + e.layerY;
                if(offsets === [0, 0]) {
                    tab.style.left = (e.clientX - tab.offsetWidth / 2) + "px";
                    tab.style.top = (e.clientY - tab.offsetHeight - 5) + "px";
                }
                else {
                    tab.style.left = `${offsets[0]}px`;
                    tab.style.top = `${offsets[1] - tab.offsetHeight - 5}px`;
                }
                if(parseInt(tab.style.top) < 0)
                    tab.style.top = `${5}px`;
                if(tab.style.left < 0)
                    tab.style.left = 0;
            }

            // Re-render mask according to weights range
            function updateMask(positions, weights, colorsForPositions, weightRange, imageData) {
                positions.forEach((pos, iter) => {
                    imageData.data[pos * 4] = colorsForPositions[iter][0];
                    imageData.data[pos * 4 + 1] = colorsForPositions[iter][1];
                    imageData.data[pos * 4 + 2] = colorsForPositions[iter][2];
                    if (weights[iter] <= weightRange[1] && weights[iter] >= weightRange[0])
                        imageData.data[pos * 4 + 3] = 255;
                    else
                        imageData.data[pos * 4 + 3] = 0;
                });
            }

            // Informative toast
            function toast(text) {
                let toastEl = document.querySelector(".toast");
                toastEl.innerHTML = text;
                toastEl.style.display = "block";
                toastEl.classList.add('animated', 'fadeInUp');
                setTimeout(()=>{
                    setTimeout(() => {
                        toastEl.classList.remove('animated');
                        toastEl.classList.remove('fadeInUp');
                    }, 10);
                    toastEl.style.display = "none";
                }, 2000);
            }

            function loadInterestingPoints(isFileLoadedBefore=false) {
                let root = "web/";
                if(!isFileLoadedBefore) {
                    interstingJsonFileLoaded = true;    // Setting check as true so that file isnt loaded again till the page is not refreshed
                    fetch(`${root}data/interesting.json?${Math.round(Math.random()*100)}`)
                    .then(response => {
                        if(!response.ok) {
                            throw new Error('File not present');
                        }
                        return response.json()
                    })
                    .then(data => {
                        interestingJsonData = data;
                        Object.keys(interestingJsonData).forEach(key => {
                            let interestingImageEl = document.createElement("p");
                            interestingImageEl.innerHTML = key;
                            let interestingPatchesContainer = document.querySelector(".interestingPatchesContainer");
                            interestingPatchesContainer.appendChild(interestingImageEl);
                            interestingImageEl.onclick = () => {
                                let patchCompareContainer = document.querySelector(".patchCompareContainer");
                                patchCompareContainer.innerHTML = "";
                                document.querySelector(".block2").style.display = "none";
                                imageName = interestingImageEl.innerHTML;
                                let path = `${root}data/${imageName}/`;

                                let event = new Event('change');
                                ogImageInput.src = path+`${imageName}.jpg`;

                                // Check if file exists in "data/imgName" folder
                                fetch(ogImageInput.src)
                                    .then(response => {
                                        if(!response.ok) {
                                            throw new Error("!found")
                                        }
                                        else{
                                            console.log(response);
                                        }
                                    })
                                    .then(data => {
                                        event.injectedImage = path+`${imageName}.jpg`;
                                        ogImageInput.dispatchEvent(event);

                                        semsegImageInput.src = path+`${imageName}.png`;
                                        event.injectedImage = path+`${imageName}.png`;
                                        semsegImageInput.dispatchEvent(event);

                                        loadFile(path+`${imageName}.csv`);
                                    })
                                    .catch(err => {
                                        // When file is not found in the path, open file dialog to choose srcs
                                        ogImageInput.click();
                                    });
                            };
                        });
                        if(interestingJsonData[`${imageName}`] !== undefined && interestingJsonData[`${imageName}`] !== null) {
                            interestingPositions = new Set(Object.values(interestingJsonData[`${imageName}`]));
                            [...interestingPositions].forEach(el => renderInterestingPoint(el));
                        }
                        else
                            interestingPositions = new Set();
                    })
                    .catch(err => {
                        console.log(err);
                    });
                }
                else {
                    // When user uploads photo using file picker
                    if(interestingJsonData[`${imageName}`] !== undefined && interestingJsonData[`${imageName}`] !== null) {
                        interestingPositions = new Set(Object.values(interestingJsonData[`${imageName}`]));
                        [...interestingPositions].forEach(el => renderInterestingPoint(el));
                    }
                    else {
                        interestingPositions = new Set();
                    }
                }
            }

            // Render interesting point on the canvas
            function renderInterestingPoint(position = 100) {
                let canvas1Rect = canvas1.getBoundingClientRect();
                let templateCircle = document.querySelector(".templatePoint");
                let circleSvg = templateCircle.cloneNode(true);
                circleSvg.classList.remove("templatePoint");
                circleSvg.setAttribute("class", "interestingPointSvg");
                circleSvg.setAttribute("pos1D", position);
                let position1D = position;
                position = pos1D22D(position, ogCanvasWidth);
                circleSvg.onclick = (e) => {
                    if(e.ctrlKey && e.altKey){
                        interestingPositions.delete(position1D);
                        if(interestingPositions.size === 0)
                                delete interestingJsonData[imageName];
                            else
                                interestingJsonData[imageName] = [...interestingPositions];
                        deleteInterestingPoint(position1D);
                    }
                    else {
                        let clickEvent = new Event("click");
                        let mousemoveEvent = new Event("mousemove");
                        mousemoveEvent.layerX = position[1];
                        mousemoveEvent.layerY = position[0];
                        clickEvent.layerX = position[1];
                        clickEvent.layerY = position[0];
                        clickEvent.isInteresting = true;
                        canvas1.dispatchEvent(mousemoveEvent);
                        canvas1.dispatchEvent(clickEvent);
                    }
                };
                circleSvg.style.top = canvas1Rect.top + position[0];
                circleSvg.style.left = canvas1Rect.left + position[1];
                circleSvg.style.display = "block";

                let interestingPointsContainer = document.querySelector(".interestingPointsContainer");
                interestingPointsContainer.style.width = `${canvas1.getAttribute("width")}px`;
                interestingPointsContainer.style.height = `${canvas1.getAttribute("height")}px`;
                interestingPointsContainer.style.position = "absolute";
                interestingPointsContainer.appendChild(circleSvg);
            }

            // delete Interesting point
            function deleteInterestingPoint(position) {
                let interestingPointsContainer = document.querySelectorAll(`.interestingPointSvg[pos1D="${position}"]`);
                interestingPointsContainer[0].remove();
            }

            document.onkeypress = (e) => {
                // Press Q to toggle interesting points visibility
                if(e.key === "q") {
                    toggleInterestingPoints();
                }
                // Press S to save interesting points to JSON file
                else if(e.key === "s") {
                    download(JSON.stringify(interestingJsonData));
                }
                // For modal
                else if(e.key === "c") {
					if(document.querySelector(".controlsModal").classList.contains("is-active")){
						document.querySelector(".controlsModal").classList.remove("is-active");
					}
					else{
						document.querySelector(".controlsModal").classList.add("is-active");
						toggleControlsModal();
					}
				}
            };

            // To save interestingPoints into a file
            function download(content, fileName="interesting.json", contentType="application/json") {
                let a = document.createElement("a");
                let file = new Blob([content], {type: contentType});
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
            }

            // To toggle visibility of interesting points
            function toggleInterestingPoints() {
                let interestingPointsContainer = document.querySelector(".interestingPointsContainer");
                if(interestingPointsContainer.style.display === "none")
                    interestingPointsContainer.style.display = "block";
                else
                    interestingPointsContainer.style.display = "none";
            }

            // Release patches back to their original parent from compare container
            function closePatchCompareContainer() {
                let patchCompareContainer = document.querySelector(".patchCompareContainer");
                let patches = patchCompareContainer.childNodes;
                let classID;
                while(patches.length > 0) {
                    classID = patches[0].getAttribute("classID");
                    patches[0].removeAttribute("compare");
                    document.querySelectorAll(`.patchClassContainer[classID="${classID}"] > .body`)[0].appendChild(patches[0]);
                }
                toggleCompareContainer();
                document.querySelector(".block2").style.display = "none";
            }

            function toggleCompareContainer() {
                let block2 = document.querySelector(".block2");
                let expandIcon = document.querySelector(".expand > span");
                let block2Rect = block2.getBoundingClientRect();
                if(block2.style.right === "" || parseInt(block2.style.right) >= 0) {
                    block2.style.right = `-${block2Rect.width+10}px`;
                    expandIcon.style.transform = "rotate(180deg)";
                }
                else {
                    block2.style.right = `0`;
                    expandIcon.style.transform = "rotate(0deg)";
                }
            }

            // Find classID and className given the color of pixel
            const findClass = (color) => classlist.filter(
                item => JSON.stringify(item.rgb) === JSON.stringify(color)
            );
        </script>
        <script>
            // Lookup for gradCam color values
            let heatmapSelect = document.querySelector(".heatmapSelect > select");
            Object.keys(colorMaps).forEach(key => {
               let option = document.createElement("option");
               option.appendChild(document.createTextNode(key));
               option.value = key;
               heatmapSelect.appendChild(option);
            });
            let ogColormap = "jet";
            heatmapSelect.onchange = () => {
                ogColormap = heatmapSelect.value;
            };
            let gradCanvas = document.createElement("canvas");
            let gradCtx = gradCanvas.getContext("2d");
            let grad = gradCtx.createLinearGradient(0, 0, 100, 0);
            let alpha = 1;
            Object.values(colorMaps[ogColormap]).forEach(entry => grad.addColorStop(entry.index, `rgb(${entry.rgb[0]}, ${entry.rgb[1]}, ${entry.rgb[2]}, ${alpha})`));
            gradCtx.fillStyle = grad;
            gradCtx.fillRect(0, 0, 100, 10);

            function getGradCamColor(index) {
                return gradCtx.getImageData(index.toFixed(2)*100, 0, 1, 1).data;
            }
            function createScale(dims, colormap=ogColormap) {
                let scaleCanvas = document.createElement("canvas");
                scaleCanvas.width = dims[0];
                scaleCanvas.height = dims[1];
                scaleCanvas.setAttribute("class", "gradCamScale");
                let scaleCtx = scaleCanvas.getContext("2d");
                let gradient = scaleCtx.createLinearGradient(dims[0], dims[1], 0, 0);
                Object.values(colorMaps[colormap])
                    .forEach(entry =>
                        gradient.addColorStop(entry.index, `rgb(${entry.rgb[0]}, ${entry.rgb[1]}, ${entry.rgb[2]}, 1)`
                    ));
                scaleCtx.fillStyle = gradient;
                scaleCtx.fillRect(0, 0, dims[0], dims[1]);

                let scaleContainer = document.createElement("div");
                scaleContainer.setAttribute("class", "scaleContainer");
                scaleContainer.appendChild(scaleCanvas);

                let gradCamSlider = document.createElement("div");
                gradCamSlider.setAttribute("class", "gradCamSlider");
                gradCamSlider.style.height = `${dims[1]}px`;

                noUiSlider.create(gradCamSlider, {
                    start: [0.5, 1],
                    behaviour: 'drag',
                    connect: true,
                    direction: 'rtl',
                    orientation: 'vertical',
                    range: {
                        'min': 0,
                        'max': 1
                    }
                });
                scaleContainer.appendChild(gradCamSlider);
                return [scaleContainer, gradient];
            }
        </script>
    </body>
</html>
